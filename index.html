<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>KY Messenger Ultimate</title>
    <style>
        :root {
            --bg: linear-gradient(135deg, #0f0c29 0%, #302b63 50%, #24243e 100%);
            --glass: rgba(255, 255, 255, 0.1);
            --accent: linear-gradient(90deg, #8e2de2, #4a00e0);
            --text: #ffffff;
            --panel: rgba(0, 0, 0, 0.4);
        }
        [data-theme="light"] {
            --bg: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
            --glass: rgba(0, 0, 0, 0.05);
            --text: #2c3e50;
            --panel: rgba(255, 255, 255, 0.8);
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', Roboto, sans-serif; transition: 0.2s; }
        body { background: var(--bg); background-attachment: fixed; color: var(--text); margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; align-items: center; }
        
        #app, #auth { 
            width: 100%; max-width: 450px; height: 95vh; 
            background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); 
            border: 1px solid rgba(255, 255, 255, 0.1); display: flex; flex-direction: column; 
            margin: 10px; border-radius: 25px; box-shadow: 0 20px 50px rgba(0,0,0,0.5); 
        }
        
        #app { display: none; }
        .screen { display: none; flex-direction: column; height: 100%; }
        .active { display: flex; }
        
        .header { padding: 15px 20px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-radius: 25px 25px 0 0; }
        
        .chat-item { 
            padding: 12px 15px; margin: 8px 12px; background: rgba(255,255,255,0.05); border-radius: 15px; 
            cursor: pointer; display: flex; align-items: center; gap: 12px; border: 1px solid rgba(255,255,255,0.05); 
        }
        
        .avatar-img { 
            width: 45px; height: 45px; border-radius: 50%; object-fit: cover; 
            background: var(--accent); display: flex; align-items: center; justify-content: center; 
            font-weight: bold; color: white; border: 1px solid rgba(255,255,255,0.2);
        }
        
        #chatContent { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        
        .msg { padding: 10px 15px; border-radius: 18px; max-width: 85%; word-wrap: break-word; position: relative; line-height: 1.4; }
        .out { align-self: flex-end; background: var(--accent); color: white; border-bottom-right-radius: 4px; box-shadow: 0 4px 15px rgba(142, 45, 226, 0.3); }
        .in { align-self: flex-start; background: rgba(255, 255, 255, 0.1); border-bottom-left-radius: 4px; border: 1px solid rgba(255,255,255,0.05); }
        
        .msg img, .msg video, .msg iframe { max-width: 100%; border-radius: 12px; margin-top: 8px; display: block; border: none; }
        .status { font-size: 10px; opacity: 0.6; margin-left: 5px; float: right; margin-top: 4px; }
        
        .input-area { display: flex; padding: 15px; background: var(--panel); gap: 10px; border-radius: 0 0 25px 25px; }
        input { flex: 1; padding: 12px 15px; border-radius: 15px; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.1); color: var(--text); outline: none; }
        button { padding: 10px 18px; border-radius: 15px; border: none; background: var(--accent); color: white; font-weight: bold; cursor: pointer; }
        button:disabled { opacity: 0.5; cursor: not-allowed; }

        .settings-scroll { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
    </style>
</head>
<body data-theme="dark">

<audio id="notifSound" src="https://www.soundjay.com/buttons/sounds/button-20.mp3"></audio>

<div id="auth">
    <div style="padding:40px; text-align:center; display:flex; flex-direction:column; gap:20px; justify-content:center; height:100%;">
        <h1 style="font-size: 80px; margin: 0; background: var(--accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent; font-weight: 900;">KY</h1>
        <input type="text" id="uLog" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" id="uPass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="authAction('login')">–í–æ–π—Ç–∏</button>
        <button onclick="authAction('reg')" style="background:none; border: 1px solid rgba(255,255,255,0.1);">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
</div>

<div id="app">
    <div id="listScreen" class="screen active">
        <div class="header"><h2>–ß–∞—Ç—ã</h2><button onclick="showScreen('settingsScreen')" style="background:none; font-size:22px;">‚öôÔ∏è</button></div>
        <div style="padding:10px;"><button onclick="startPrivateChat()" style="width:100%">+ –ù–∞–ø–∏—Å–∞—Ç—å –¥—Ä—É–≥—É</button></div>
        <div id="chatsList" style="overflow-y: auto; flex: 1;"></div>
    </div>

    <div id="chatScreen" class="screen">
        <div class="header">
            <button onclick="showScreen('listScreen')" style="background:none; color:var(--text); font-size:22px;">‚Üê</button>
            <b id="chatTitle">–ß–∞—Ç</b>
            <div style="width:24px"></div>
        </div>
        <div id="chatContent"></div>
        <div class="input-area">
            <input type="text" id="msgInp" placeholder="–¢–µ–∫—Å—Ç...">
            <button id="sendBtn" onclick="sendMsg()">‚û§</button>
        </div>
    </div>

    <div id="settingsScreen" class="screen">
        <div class="header"><button onclick="showScreen('listScreen')" style="background:none; color:var(--text); font-size:22px;">‚Üê</button><b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b><button onclick="toggleTheme()" style="background:none;">üåì</button></div>
        <div class="settings-scroll">
            <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å</label>
            <input type="range" id="volRange" min="0" max="1" step="0.1" value="0.5" onchange="updateVol()">
            <label>–ê–≤–∞—Ç–∞—Ä (URL)</label>
            <input type="text" id="inpAva" placeholder="https://...">
            <button onclick="updateUser('avatar')">–û–±–Ω–æ–≤–∏—Ç—å</button>
            <label>–û–±–æ–∏ —á–∞—Ç–∞ (URL)</label>
            <input type="text" id="inpWall" placeholder="https://...">
            <button onclick="setWallpaper()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button onclick="location.reload()" style="background:rgba(255,0,0,0.2); color:#ff4d4d; margin-top:20px;">–í—ã—Ö–æ–¥</button>
            <div onclick="secret()" style="text-align:center; opacity:0.1; font-size:10px; margin-top:20px; cursor:pointer;">v.6.1.1</div>
        </div>
    </div>
</div>

<script>
    const API = 'https://sheetdb.io/api/v1/b6urq429yuqec';
    let myName = "", myPass = "", chatTarget = "", allUsers = {}, lastMsgCount = 0, hasSecret = false, vClicks = 0;

    async function authAction(type) {
        const l = document.getElementById('uLog').value.trim(), p = document.getElementById('uPass').value.trim();
        if(!l || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏ –ø–æ–ª—è");
        try {
            const res = await fetch(`${API}/search?sheet=users&login=${l}`);
            const data = await res.json();
            if(type === 'login') {
                if(data.length > 0 && String(data[0].password) === String(p)) {
                    myName = l; myPass = p;
                    document.getElementById('auth').style.display = 'none';
                    document.getElementById('app').style.display = 'flex';
                    loadAppData(true); setInterval(loadAppData, 4000);
                } else alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ª–æ–≥–∏–Ω –∏–ª–∏ –ø–∞—Ä–æ–ª—å");
            } else {
                if(data.length > 0) return alert("–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç");
                await fetch(`${API}?sheet=users`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify([{login: l, password: p, avatar: ''}]) });
                alert("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω!");
            }
        } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
    }

    async function loadAppData(isFirst = false) {
        try {
            const [mRes, uRes] = await Promise.all([fetch(`${API}?sheet=Sheet1`), fetch(`${API}?sheet=users`)]);
            const msgs = await mRes.json(), users = await uRes.json();
            users.forEach(u => allUsers[u.login] = u.avatar);
            if (!isFirst && msgs.length > lastMsgCount) {
                const last = msgs[msgs.length - 1];
                if (last.to === myName || (hasSecret && last.to === 'GLOBAL' && last.name !== myName)) {
                    document.getElementById('notifSound').play().catch(()=>{});
                }
            }
            lastMsgCount = msgs.length;
            const partners = new Set();
            msgs.forEach(m => { 
                if(m.name === myName && m.to && m.to !== "GLOBAL") partners.add(m.to); 
                if(m.to === myName && m.name !== "GLOBAL") partners.add(m.name); 
            });
            const list = document.getElementById('chatsList');
            let html = hasSecret ? `<div class="chat-item" onclick="openChat('GLOBAL')" style="background:rgba(142,45,226,0.2); border:1px solid #8e2de2;"><div class="avatar-img">üåç</div><b>–û–±—â–∏–π —á–∞—Ç</b></div>` : "";
            Array.from(partners).forEach(p => {
                const avaUrl = allUsers[p];
                const ava = (avaUrl && avaUrl.startsWith('http')) ? `<img src="${avaUrl}" class="avatar-img">` : `<div class="avatar-img">${p[0].toUpperCase()}</div>`;
                html += `<div class="chat-item" onclick="openChat('${p}')">${ava}<b>${p}</b></div>`;
            });
            list.innerHTML = html;
            if(chatTarget) render(msgs);
        } catch(e) {}
    }

    function render(data) {
        const filtered = data.filter(m => {
            const isTarget = chatTarget === "GLOBAL" ? m.to === "GLOBAL" : (m.name === myName && m.to === chatTarget) || (m.name === chatTarget && m.to === myName);
            const hasText = m.message && String(m.message).trim() !== "" && String(m.message) !== "undefined";
            return isTarget && hasText;
        });
        
        document.getElementById('chatContent').innerHTML = filtered.map(m => {
            let content = String(m.message);
            const url = content.trim();
            if(url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=)?(.+)/)) {
                const id = url.split('v=')[1] || url.split('/').pop();
                content = `<iframe width="100%" height="200" src="https://www.youtube.com/embed/${id}" allowfullscreen></iframe>`;
            } else if(url.match(/\.(mp4|webm|ogg)$/i)) content = `<video controls style="width:100%"><source src="${url}"></video>`;
            else if(url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) content = `<img src="${url}" style="width:100%">`;
            
            const isOut = m.name === myName;
            return `<div class="msg ${isOut ? 'out' : 'in'}"><small style="font-size:10px; opacity:0.7; display:block; margin-bottom:4px;">${m.name}</small>${content}<span class="status">${isOut ? '‚úì' : ''}</span></div>`;
        }).join('');
        const box = document.getElementById('chatContent');
        box.scrollTop = box.scrollHeight;
    }

    async function sendMsg() {
        const i = document.getElementById('msgInp');
        const btn = document.getElementById('sendBtn');
        const txt = i.value.trim();
        if(!txt || !chatTarget) return;

        btn.disabled = true;
        btn.innerText = "...";

        try {
            const res = await fetch(`${API}?sheet=Sheet1`, { 
                method: 'POST', 
                headers: {'Content-Type': 'application/json'}, 
                body: JSON.stringify([{
                    name: String(myName), 
                    to: String(chatTarget), 
                    message: String(txt)
                }]) 
            });
            if (res.ok) {
                i.value = "";
                loadAppData();
            } else {
                alert("–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –ª–∏–º–∏—Ç—ã SheetDB.");
            }
        } catch(e) {
            alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–Ω–æ–≤–∞.");
        } finally {
            btn.disabled = false;
            btn.innerText = "‚û§";
        }
    }

    function secret() { 
        vClicks++; 
        if(vClicks >= 5) {
            const code = prompt("–ö–æ–¥ –¥–æ—Å—Ç—É–ø–∞:");
            if(code === "–º–∞–∫—Å –≥–æ–≤–Ω–æ") {
                hasSecret = true; alert("–û–±—â–∏–π —á–∞—Ç –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω!"); showScreen('listScreen'); loadAppData();
            } else vClicks = 0;
        }
    }
    function openChat(t) { chatTarget = t; document.getElementById('chatTitle').innerText = t === 'GLOBAL' ? 'üåç –û–±—â–∏–π —á–∞—Ç' : t; showScreen('chatScreen'); }
    function startPrivateChat() { const t = prompt("–õ–æ–≥–∏–Ω –¥—Ä—É–≥–∞:"); if(t && t !== myName) openChat(t); }
    function updateVol() { document.getElementById('notifSound').volume = document.getElementById('volRange').value; }
    function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function setWallpaper() { document.getElementById('chatContent').style.background = `url('${document.getElementById('inpWall').value}') center/cover no-repeat`; }
    async function updateUser(m) { 
        await fetch(`${API}/login/${myName}?sheet=users`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify({avatar: document.getElementById('inpAva').value}) });
        alert("–ê–≤–∞—Ç–∞—Ä –æ–±–Ω–æ–≤–ª–µ–Ω!"); loadAppData();
    }
</script>
</body>
</html>
