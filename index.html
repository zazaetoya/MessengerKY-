<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KY Messenger Ultimate</title>
    <style>
        :root {
            --bg: linear-gradient(135deg, #1a0a2e 0%, #3b1c71 100%);
            --glass: rgba(255, 255, 255, 0.1);
            --accent: linear-gradient(90deg, #8e2de2, #4a00e0);
            --text: #ffffff;
            --panel: rgba(0, 0, 0, 0.3);
        }
        [data-theme="light"] {
            --bg: linear-gradient(135deg, #e0e0e0 0%, #ffffff 100%);
            --glass: rgba(0, 0, 0, 0.05);
            --text: #202124;
            --panel: rgba(255, 255, 255, 0.7);
        }
        * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; transition: 0.3s; }
        body { background: var(--bg); background-attachment: fixed; color: var(--text); margin: 0; display: flex; justify-content: center; height: 100vh; overflow: hidden; align-items: center; }
        #app, #auth { width: 100%; max-width: 450px; height: 90vh; background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px); border: 1px solid rgba(255, 255, 255, 0.1); display: flex; flex-direction: column; margin: 10px; border-radius: 30px; box-shadow: 0 10px 30px rgba(0,0,0,0.5); }
        #app { display: none; }
        .screen { display: none; flex-direction: column; height: 100%; }
        .active { display: flex; }
        .header { padding: 20px; background: var(--panel); display: flex; justify-content: space-between; align-items: center; border-radius: 30px 30px 0 0; }
        .chat-item { padding: 15px; margin: 10px; background: var(--glass); border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 15px; border: 1px solid rgba(255,255,255,0.1); }
        .avatar-img { width: 45px; height: 45px; border-radius: 50%; object-fit: cover; background: var(--accent); display: flex; align-items: center; justify-content: center; font-weight: bold; color: white; border: 1px solid rgba(255,255,255,0.2); }
        #chatContent { flex: 1; overflow-y: auto; padding: 15px; display: flex; flex-direction: column; gap: 10px; }
        .msg { padding: 12px; border-radius: 18px; max-width: 85%; backdrop-filter: blur(5px); border: 1px solid rgba(255,255,255,0.1); word-wrap: break-word; position: relative; }
        .out { align-self: flex-end; background: rgba(142, 45, 226, 0.5); border-bottom-right-radius: 4px; padding-right: 30px; }
        .in { align-self: flex-start; background: rgba(255, 255, 255, 0.1); border-bottom-left-radius: 4px; }
        .msg img, .msg video, .msg iframe { max-width: 100%; border-radius: 10px; margin-top: 8px; display: block; }
        .status { position: absolute; bottom: 5px; right: 8px; font-size: 10px; opacity: 0.6; }
        input { padding: 12px; border-radius: 15px; border: none; background: rgba(255,255,255,0.2); color: var(--text); outline: none; }
        button { padding: 12px; border-radius: 15px; border: none; background: var(--accent); color: white; font-weight: bold; cursor: pointer; }
        .settings-scroll { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        label { font-size: 11px; opacity: 0.6; margin-bottom: -5px; padding-left: 5px; }
    </style>
</head>
<body data-theme="dark">

<audio id="notifSound" src="https://www.soundjay.com/buttons/sounds/button-20.mp3"></audio>

<div id="auth">
    <div style="padding:40px; text-align:center; display:flex; flex-direction:column; gap:15px; justify-content:center; height:100%;">
        <h1 style="font-size: 80px; margin: 0; background: var(--accent); -webkit-background-clip: text; -webkit-text-fill-color: transparent;">KY</h1>
        <input type="text" id="uLog" placeholder="–õ–æ–≥–∏–Ω">
        <input type="password" id="uPass" placeholder="–ü–∞—Ä–æ–ª—å">
        <button onclick="authAction('login')">–í–æ–π—Ç–∏</button>
        <button onclick="authAction('reg')" style="background:none;">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
    </div>
</div>

<div id="app">
    <div id="listScreen" class="screen active">
        <div class="header"><h2>KY</h2><button onclick="showScreen('settingsScreen')" style="background:none; font-size:24px;">‚öôÔ∏è</button></div>
        <div style="padding:10px;"><button onclick="startPrivateChat()" style="width:100%">+ –ù–∞–ø–∏—Å–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ</button></div>
        <div id="chatsList" style="overflow-y: auto; flex: 1;"></div>
    </div>

    <div id="chatScreen" class="screen">
        <div class="header"><button onclick="showScreen('listScreen')" style="background:none; color:var(--text); font-size:24px;">‚Üê</button><b id="chatTitle">–ß–∞—Ç</b><div style="width:24px"></div></div>
        <div id="chatContent"></div>
        <div style="display:flex; padding:15px; background:var(--panel); gap:10px;">
            <input type="text" id="msgInp" placeholder="–°–æ–æ–±—â–µ–Ω–∏–µ –∏–ª–∏ —Å—Å—ã–ª–∫–∞..." style="flex:1">
            <button onclick="sendMsg()">‚û§</button>
        </div>
    </div>

    <div id="settingsScreen" class="screen">
        <div class="header"><button onclick="showScreen('listScreen')" style="background:none; color:var(--text); font-size:24px;">‚Üê</button><b>–ù–∞—Å—Ç—Ä–æ–π–∫–∏</b><button onclick="toggleTheme()" style="background:none;">üåì</button></div>
        <div class="settings-scroll">
            <label>–ì—Ä–æ–º–∫–æ—Å—Ç—å —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–π</label>
            <input type="range" id="volRange" min="0" max="1" step="0.1" value="0" onchange="updateVol()">
            <label>–ê–≤–∞—Ç–∞—Ä (URL)</label><input type="text" id="inpAva" placeholder="https://..."><button onclick="updateUser('avatar')">–û–∫</button>
            <label>–û–±–æ–∏ —á–∞—Ç–∞</label><input type="text" id="inpWall" placeholder="URL —Ñ–æ–Ω–∞"><button onclick="setWallpaper()">–ü—Ä–∏–º–µ–Ω–∏—Ç—å</button>
            <button onclick="location.reload()" style="background:rgba(255,0,0,0.3); margin-top:20px;">–í—ã—Ö–æ–¥</button>
            <div onclick="secret()" style="text-align:center; opacity:0.1; font-size:10px; margin-top:20px; cursor:pointer;">v.6.0.6</div>
        </div>
    </div>
</div>

<script>
    const API = 'https://sheetdb.io/api/v1/b6urq429yuqec';
    let myName = "", myPass = "", chatTarget = "", allUsers = {}, lastMsgCount = 0, hasSecret = false, vClicks = 0;

    async function authAction(type) {
        const l = document.getElementById('uLog').value.trim(), p = document.getElementById('uPass').value.trim();
        if(!l || !p) return;
        try {
            const res = await fetch(`${API}/search?sheet=users&login=${l}`);
            const data = await res.json();
            if(type === 'login') {
                if(data.length > 0 && String(data[0].password) === String(p)) {
                    myName = l; myPass = p;
                    document.getElementById('auth').style.display = 'none';
                    document.getElementById('app').style.display = 'flex';
                    loadAppData(true); setInterval(loadAppData, 4000);
                } else alert("–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞!");
            } else {
                if(data.length > 0) return alert("–õ–æ–≥–∏–Ω –∑–∞–Ω—è—Ç");
                await fetch(`${API}?sheet=users`, { method: 'POST', headers: {'Content-Type': 'application/json'}, body: JSON.stringify([{login: l, password: p, avatar: ''}]) });
                alert("–ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω!");
            }
        } catch(e) { alert("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏"); }
    }

    async function loadAppData(isFirst = false) {
        try {
            const [mRes, uRes] = await Promise.all([fetch(`${API}?sheet=Sheet1`), fetch(`${API}?sheet=users`)]);
            const msgs = await mRes.json(), users = await uRes.json();
            
            users.forEach(u => allUsers[u.login] = u.avatar);
            
            if (!isFirst && msgs.length > lastMsgCount) {
                const last = msgs[msgs.length - 1];
                if (last.to === myName || (hasSecret && last.to === 'GLOBAL' && last.name !== myName)) {
                    document.getElementById('notifSound').play().catch(()=>{});
                }
            }
            lastMsgCount = msgs.length;

            const partners = new Set();
            msgs.forEach(m => { 
                if(m.name === myName && m.to && m.to !== "GLOBAL") partners.add(m.to); 
                if(m.to === myName && m.name !== "GLOBAL") partners.add(m.name); 
            });

            const list = document.getElementById('chatsList');
            let html = hasSecret ? `<div class="chat-item" onclick="openChat('GLOBAL')" style="border: 1px solid #8e2de2; background: rgba(142, 45, 226, 0.1);"><div class="avatar-img">üåç</div><b>–í—Å–µ–æ–±—â–∏–π —á–∞—Ç</b></div>` : "";
            
            Array.from(partners).forEach(p => {
                const avaUrl = allUsers[p];
                const ava = (avaUrl && avaUrl.startsWith('http')) ? `<img src="${avaUrl}" class="avatar-img">` : `<div class="avatar-img">${p[0].toUpperCase()}</div>`;
                html += `<div class="chat-item" onclick="openChat('${p}')">${ava}<b>${p}</b></div>`;
            });
            list.innerHTML = html;
            if(chatTarget) render(msgs);
        } catch(e) {}
    }

    function render(data) {
        const filtered = data.filter(m => chatTarget === "GLOBAL" ? m.to === "GLOBAL" : (m.name === myName && m.to === chatTarget) || (m.name === chatTarget && m.to === myName));
        document.getElementById('chatContent').innerHTML = filtered.map(m => {
            let content = m.message;
            const url = String(m.message).trim();
            
            const ytMatch = url.match(/(?:https?:\/\/)?(?:www\.)?(?:youtube\.com|youtu\.be)\/(?:watch\?v=)?(.+)/);
            if(ytMatch) content = `<iframe width="100%" height="200" src="https://www.youtube.com/embed/${ytMatch[1]}" allowfullscreen></iframe>`;
            else if(url.match(/\.(mp4|webm|ogg)$/i)) content = `<video controls><source src="${url}"></video>`;
            else if(url.match(/\.(mp3|wav)$/i)) content = `<audio controls style="width:100%"><source src="${url}"></audio>`;
            else if(url.match(/\.(jpg|jpeg|png|gif|webp)$/i)) content = `<img src="${url}">`;

            const isOut = m.name === myName;
            return `<div class="msg ${isOut ? 'out' : 'in'}">
                <small style="font-size:10px; opacity:0.6; display:block; margin-bottom:4px;">${m.name}</small>
                ${content}${isOut ? '<span class="status">‚úì</span>' : ''}
            </div>`;
        }).join('');
        const box = document.getElementById('chatContent');
        box.scrollTop = box.scrollHeight;
    }

    async function sendMsg() {
        const i = document.getElementById('msgInp');
        const txt = i.value.trim();
        if(!txt || !chatTarget) return;
        i.value = "";
        await fetch(`${API}?sheet=Sheet1`, { 
            method: 'POST', 
            headers: {'Content-Type': 'application/json'}, 
            body: JSON.stringify([{name: myName, to: chatTarget, message: txt}]) 
        });
        loadAppData();
    }

    function secret() { 
        vClicks++; 
        if(vClicks >= 5) {
            const code = prompt("–í–≤–µ–¥–∏—Ç–µ –∫–æ–¥ –¥–æ—Å—Ç—É–ø–∞:");
            if(code === "–º–∞–∫—Å –≥–æ–≤–Ω–æ") {
                hasSecret = true;
                vClicks = 0;
                alert("–ü–∞—Å—Ö–∞–ª–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞! –í—Å–µ–æ–±—â–∏–π —á–∞—Ç –¥–æ—Å—Ç—É–ø–µ–Ω –≤ —Å–ø–∏—Å–∫–µ.");
                showScreen('listScreen');
                loadAppData();
            } else { vClicks = 0; }
        }
    }

    function openChat(t) { chatTarget = t; document.getElementById('chatTitle').innerText = t === 'GLOBAL' ? '–û–±—â–∏–π —á–∞—Ç' : t; showScreen('chatScreen'); }
    function startPrivateChat() { const t = prompt("–í–≤–µ–¥–∏—Ç–µ –ª–æ–≥–∏–Ω –¥—Ä—É–≥–∞:"); if(t && t !== myName) openChat(t); }
    function updateVol() { document.getElementById('notifSound').volume = document.getElementById('volRange').value; }
    function toggleTheme() { document.body.setAttribute('data-theme', document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark'); }
    function showScreen(id) { document.querySelectorAll('.screen').forEach(s => s.classList.remove('active')); document.getElementById(id).classList.add('active'); }
    function setWallpaper() { document.getElementById('chatContent').style.backgroundImage = `url('${document.getElementById('inpWall').value}')`; document.getElementById('chatContent').style.backgroundSize = 'cover'; }
    async function updateUser(m) { 
        const payload = m === 'avatar' ? { avatar: document.getElementById('inpAva').value } : { login: document.getElementById('newName').value || myName, password: document.getElementById('newPass').value || myPass };
        await fetch(`${API}/login/${myName}?sheet=users`, { method: 'PATCH', headers: {'Content-Type': 'application/json'}, body: JSON.stringify(payload) });
        location.reload(); 
    }
</script>
</body>
</html>
